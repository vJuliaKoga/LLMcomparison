金融系E2Eテストケース生成のためのLLM評価プラン
①評価手法の妥当性判断と推奨プラン

現状案の評価

| ツール | 適合性 | 判断理由 |
|--------|--------|----------|
| OpenRouter | ⭐⭐⭐⭐⭐ | 複数モデルへの統一アクセス、コスト比較に最適 |
| Promptfoo | ⭐⭐⭐⭐⭐ | テストケース生成品質の定量評価に理想的 |
| LibreChat/Big-AGI | ⭐⭐⭐ | デモには有用だが評価には不要 |

推奨する評価フレームワーク

``
【フェーズ1：モデル選定】OpenRouter + Promptfoo
↓
【フェーズ2：品質検証】実際のテストケース生成タスク
↓
【フェーズ3：コスト分析】トークン数 × 単価計算
`

具体的な評価手順
Step 1: 評価対象モデルの選定

無料/低コストで試せる推奨モデル：

| モデル | 強み | 取得方法 |
|--------|------|----------|
| GPT-4o | 構造化出力、金融用語理解 | OpenAI API（既存） |
| Claude 3.5 Sonnet | 長文理解、論理的思考 | Anthropic無料枠 |
| Gemini 1.5 Pro | 長いコンテキスト、コスパ | Google AI Studio無料 |
| Llama 3.1 70B | オープンソース、カスタマイズ性 | OpenRouter無料枠 |
| Qwen2.5 72B | 多言語、技術文書 | OpenRouter |

Step 2: Promptfooでの評価設計

promptfoo.yaml サンプル構成：

`yaml
prompts:
  - file://prompts/test-case-generation.txt

providers:
  - openai:gpt-4o
  - anthropic:claude-3-5-sonnet-20241022
  - google:gemini-1.5-pro
  - openrouter:meta-llama/llama-3.1-70b-instruct
  - openrouter:qwen/qwen-2.5-72b-instruct

tests:
  - vars:
      feature: "管理者権限でのログイン後、顧客データ閲覧"
      requirements: "正常系3ケース、異常系5ケース、境界値2ケース"
    assert:
      - type: contains
        value: "テストケースID"
      - type: contains
        value: "期待結果"
      - type: javascript
        value: output.split('\n').length >= 10
      - type: llm-rubric
        value: "テストケースが具体的で実行可能か"

  - vars:
      feature: "不正ログイン試行の検知とロック"
      requirements: "セキュリティ要件を含む"
    assert:
      - type: llm-rubric
        value: "金融系セキュリティ基準を考慮しているか"
`

Step 3: 評価軸の設定

| 評価項目 | 重要度 | 測定方法 |
|----------|--------|----------|
| 網羅性 | 高 | 正常/異常/境界値の比率 |
| 具体性 | 高 | 実行手順の明確さ（LLM-as-Judge） |
| 金融業務理解 | 高 | 専門用語の適切性 |
| 構造化品質 | 中 | JSONスキーマ準拠率 |
| コスト効率 | 高 | 1ケースあたりのトークン数 |
| 応答速度 | 中 | レイテンシ測定 |

追加推奨事項
A. より高度な評価手法
人間評価の併用
   - Promptfooの結果上位3モデルを人間が再評価
   - 金融系知見を持つレビュアーによるブラインドテスト

実行可能性検証
   - 生成されたテストケースを実際にSelenium等で実行
   - 実行成功率を測定

継続的評価
   - 週次でモデル性能を再評価（モデルは頻繁にアップデート）

B. コスト最適化戦略

`
【戦略1】ハイブリッドアプローチ
├─ 初期設計: Claude 3.5 Sonnet（高品質）
└─ 量産: Gemini 1.5 Flash（低コスト）

【戦略2】プロンプトキャッシング
├─ 金融用語辞書・テンプレートをキャッシュ
└─ 実行ごとのコスト50-90%削減可能
`

②金融系デモサイトの生成

以下、実際のE2Eテストケース生成評価に使える金融デモアプリを作成。
デモサイト仕様概要

機能要件：
• ユーザー認証（役割：一般顧客/管理者/監査者）
• 口座情報表示（残高、入出金履歴）
• 振込機能（金額制限、承認フロー）
• カード情報管理
• 監査ログ閲覧（管理者のみ）
• セッションタイムアウト
• 多要素認証（MFA）

テストケース生成対象となる観点：
• 権限制御（RBAC）
• 入力バリデーション（SQLインジェクション対策等）
• 金額計算の正確性
• トランザクション整合性
• セキュリティ要件
• エラーハンドリング

### サイト概要
- 3種類の役割ベースアクセス制御
- MFA認証
- セッション管理
- 監査ログ
- 振込機能（バリデーション多数）
- 30種類以上のテストケース生成可能

// 実装コードはtest.htmlとして生成済み。

### デモアプリの使い方
**セットアップ**
上記のHTMLコードを financial-demo-app.html として保存
ブラウザで開く（Chrome/Edge推奨）
テストアカウントでログイン

テストアカウント

| ユーザーID | パスワード | 役割 | 権限 |
|-----------|----------|------|------|
| customer01 | pass123 | 一般顧客 | 口座閲覧、振込（制限あり） |
| admin01 | admin123 | 管理者 | 全機能 + 監査ログ閲覧 |
| auditor01 | audit123 | 監査者 | 監査ログ閲覧 |

生成可能なテストケースの例
✅ 正常系テスト
ログイン成功
   - 正しい認証情報でログイン → MFA認証 → ダッシュボード表示

振込実行（通常金額）
   - ¥50,000を有効な口座に振込 → 残高更新 → 履歴追加

取引履歴閲覧
   - 取引履歴タブで過去の入出金を確認

カード情報表示
   - カード管理タブでCVVを表示 → 監査ログ記録

❌ 異常系テスト
ログイン失敗（3回）→ アカウントロック
   - 誤ったパスワードを3回入力 → 30秒ロック

振込上限超過
   - ¥1,500,000の振込試行 → エラー表示

残高不足
   - 残高以上の金額を振込 → エラー表示

不正な口座番号
   - 9桁や英字を含む口座番号 → バリデーションエラー

自己振込の試行
   - 自分の口座に振込 → エラー表示

セッションタイムアウト
   - 15分間操作せず → 強制ログアウト

権限外アクセス
   - 一般顧客が監査ログにアクセス試行 → タブ非表示

高額振込（承認必要）
   - 一般顧客が¥100,000以上を振込 → 承認待ち

🔒 セキュリティテスト
MFA認証失敗
   - 誤った認証コード → ログイン拒否

役割不一致
   - customer01で管理者役割を選択 → 認証失敗

CVV表示の監査
   - CVV表示 → 監査ログに記録

③ Promptfooでの評価実施手順
インストール

`powershell
Node.js がインストール済みの場合
npm install -g promptfoo

または
npx promptfoo@latest init
`

プロンプトファイル作成

prompts/test-case-generation.txt:

`
あなたは金融システムの品質保証エンジニアです。
以下の機能に対するE2Eテストケースを生成してください。

【機能】
{{feature}}

【要件】
{{requirements}}

【出力形式】
各テストケースは以下の形式で出力してください：

テストケースID: TC-XXX
カテゴリ: [正常系/異常系/境界値/セキュリティ]
優先度: [高/中/低]
前提条件: 
テスト手順:
期待結果: 
備考: 

最低10ケース以上生成してください。
`

promptfoo.yaml作成

`yaml
prompts:
  - file://prompts/test-case-generation.txt

providers:
  - id: openai:gpt-4o
    config:
      temperature: 0.3
  - id: anthropic:claude-3-5-sonnet-20241022
    config:
      temperature: 0.3

tests:
  - vars:
      feature: "ログイン機能（MFA含む）"
      requirements: "正常系2ケース、異常系5ケース、セキュリティ3ケース"
    assert:
      - type: contains
        value: "テストケースID"
      - type: javascript
        value: output.match(/TC-\d+/g).length >= 10
      - type: llm-rubric
        value: "テストケースが具体的で実行可能か"
      - type: llm-rubric
        value: "金融システムのセキュリティ要件を考慮しているか"

  - vars:
      feature: "振込機能（金額制限、承認フロー）"
      requirements: "正常系3ケース、異常系7ケース、境界値2ケース"
    assert:
      - type: contains-all
        value:
          - "残高不足"
          - "上限超過"
      - type: llm-rubric
        value: "境界値テストが適切に設計されているか"
`

実行

`powershell
promptfoo eval
promptfoo view
``
