アプローチ比較

| アプローチ | 精度 | コスト | 推奨度 | 備考 |
|-----------|------|--------|--------|------|
| ①HTMLを直接渡す | ⭐⭐⭐⭐⭐ | 高 | ⭐⭐⭐⭐ | 実装の詳細まで理解可能 |
| ②仕様書のみ渡す | ⭐⭐⭐ | 低 | ⭐⭐⭐ | 実際の実装と乖離リスク |
| ③仕様書+HTML（ハイブリッド） | ⭐⭐⭐⭐⭐ | 中 | ⭐⭐⭐⭐⭐ | 最推奨 |

推奨：ハイブリッドアプローチ
理由
仕様書: ビジネス要件・期待動作を明確化
HTMLコード: 実装の詳細（バリデーションルール、エラーメッセージ等）を正確に把握
LLMの長文理解能力: Claude 3.5 Sonnet (200K tokens) や Gemini 1.5 Pro (2M tokens) なら両方同時に処理可能

実践：仕様書生成

以下、先ほどのHTMLからテストケース生成用の仕様書を抽出します。

SecureBank デモシステム テスト仕様書
システム概要

目的: 金融機関向けオンラインバンキングシステムのデモ  
対象ユーザー: 一般顧客、管理者、監査者  
主要機能: ログイン認証、口座管理、振込、カード情報閲覧、監査ログ

ユーザー役割と権限

| 役割 | 権限 | テストアカウント |
|------|------|-----------------|
| 一般顧客 | 口座閲覧、振込（制限あり）、カード情報閲覧 | customer01 / pass123 |
| 管理者 | 全機能 + 監査ログ閲覧 + 高額振込承認 | admin01 / admin123 |
| 監査者 | 監査ログ閲覧のみ | auditor01 / audit123 |

機能仕様
3.1 ログイン機能

3.1.1 基本認証
• 入力項目: ユーザーID、パスワード、役割選択
• 検証項目:
  - ユーザーIDとパスワードの一致
  - 選択した役割とアカウント役割の一致
  - 空欄チェック

3.1.2 ログイン試行制限
• 制限回数: 3回まで
• ロック時間: 30秒
• 動作:
  - 3回失敗後、30秒間すべてのログイン試行を拒否
  - ロック中のメッセージ: "🔒 アカウントがロックされています。残りX秒"

3.1.3 多要素認証（MFA）
• タイミング: 基本認証成功後
• 認証コード: 6桁の数字（テスト用: 123456）
• 失敗時: エラーメッセージ表示、ログイン不可

3.1.4 監査ログ記録
• ログイン成功/失敗
• MFA成功/失敗
• ログイン試行回数超過

3.2 セッション管理
3.2.1 セッションタイムアウト
• 制限時間: 15分（900秒）
• カウントダウン表示: ヘッダーに "セッション: MM:SS"
• 残り60秒: タイマー背景が赤色に変化
• タイムアウト時: アラート表示 → 強制ログアウト

3.2.2 ログアウト
• トリガー: ログアウトボタン、セッションタイムアウト
• 処理: タイマー停止、監査ログ記録、ログイン画面に戻る

3.3 口座情報表示
3.3.1 表示項目
• 口座番号（10桁）
• 残高（日本円、3桁カンマ区切り）
• 今月の入金合計
• 今月の出金合計

3.3.2 アクセス権限
• 全役割: 自分の口座情報のみ閲覧可能

3.4 取引履歴
3.4.1 表示項目
• 日時（YYYY-MM-DD HH:MM形式）
• 種別（入金/出金/振込）
• 説明（取引内容）
• 金額（入金: 緑色、出金: 赤色）
• 残高（取引後）

3.4.2 表示順序
• 最新の取引が上（降順）

3.5 振込機能
3.5.1 入力項目
• 振込先口座番号: 10桁の数字のみ
• 振込金額: 正の整数
• メモ: 任意（文字列）

3.5.2 バリデーションルール

| 検証項目 | 条件 | エラーメッセージ |
|---------|------|-----------------|
| 口座番号形式 | 10桁の数字 | "振込先口座番号は10桁の数字で入力してください" |
| 金額必須 | 0より大きい | "振込金額を正しく入力してください" |
| 振込上限 | ≤ ¥1,000,000 | "1回の振込上限（¥1,000,000）を超えています" |
| 残高チェック | 金額 ≤ 残高 | "残高不足です" |
| 自己振込禁止 | 振込先 ≠ 自口座 | "自分の口座には振込できません" |

3.5.3 承認フロー
• 条件: 金額 ≥ ¥100,000 かつ 役割 = 一般顧客
• 動作: 振込実行せず、「承認待ち」状態に追加
• メッセージ: "¥100,000以上の振込は管理者承認が必要です"

3.5.4 成功時の処理
残高から振込金額を減算
取引履歴に追加（種別: 振込、金額: マイナス値）
画面の残高表示を更新
成功メッセージ表示（3秒後に自動消去）
監査ログ記録

3.6 カード情報管理
3.6.1 表示項目
• カード番号: XXXX-XXXX-XXXX-XXXX形式
  - 概要画面: 下4桁のみ表示（例: *---9012）
  - 詳細画面: 全桁表示
• 名義: ユーザー名
• 有効期限: MM/YY形式
• CVV: デフォルトは "**"、ボタンクリックで表示切替
• 利用限度額: 日本円

3.6.2 セキュリティ
• CVV表示時: 監査ログに記録（level: warning）

3.7 監査ログ（管理者・監査者のみ）
3.7.1 記録項目
• タイムスタンプ（YYYY-MM-DD HH:MM:SS）
• ログレベル（info / warning / error）
• メッセージ内容

3.7.2 記録対象イベント

| レベル | イベント例 |
|--------|----------|
| info | ログイン成功、ログアウト、振込実行、システム起動 |
| warning | ログイン失敗、MFA失敗、CVV表示、承認待ち振込、振込上限超過 |
| error | ログイン試行回数超過、ロック中のログイン試行 |

3.7.3 表示形式
• 最新ログが上（降順）
• ログレベルごとに左ボーダー色が変化
  - info: 青色
  - warning: オレンジ色
  - error: 赤色

3.7.4 アクセス制限
• 一般顧客: 監査ログタブ非表示
• 管理者・監査者: 監査ログタブ表示

データ仕様
4.1 アカウントマスタ

``javascript
{
  username: string,        // ユーザーID
  password: string,        // パスワード（平文: デモ用）
  role: 'customer' | 'admin' | 'auditor',
  name: string,           // 氏名
  accountNumber: string,  // 10桁の口座番号
  balance: number,        // 残高（円）
  cardNumber: string,     // XXXX-XXXX-XXXX-XXXX形式
  cardExpiry: string,     // MM/YY形式
  cvv: string,            // 3桁
  cardLimit: number,      // カード限度額（円）
  transactions: Array     // 取引履歴
}
`

4.2 取引データ

`javascript
{
  date: string,     // YYYY-MM-DD HH:MM形式
  type: string,     // '入金' | '出金' | '振込'
  desc: string,     // 取引説明
  amount: number,   // 金額（入金: 正、出金: 負）
  balance: number   // 取引後残高
}
`

エラーハンドリング
5.1 エラー表示方式
• 表示場所: 各フォームの上部
• 背景色: 薄いピンク（#fee）
• 自動消去: 5秒後

5.2 主要エラーメッセージ一覧

| エラー分類 | メッセージ | トリガー条件 |
|-----------|----------|-------------|
| 入力不足 | "ユーザーIDとパスワードを入力してください" | ログイン時、空欄 |
| 認証失敗 | "認証失敗（残りX回）" | ID/パスワード不一致 |
| アカウントロック | "アカウントがロックされています。残りX秒" | 3回失敗後 |
| MFA失敗 | "認証コードが正しくありません" | MFA不一致 |
| バリデーション | "振込先口座番号は10桁の数字で入力してください" | 口座番号形式不正 |
| ビジネスルール | "残高不足です" | 残高 < 振込金額 |

非機能要件
6.1 セキュリティ
• パスワードは入力時に type="password" でマスク
• CVV表示は能動的なアクションが必要
• すべての認証失敗を監査ログに記録

6.2 ユーザビリティ
• エラーメッセージは絵文字付きで視認性向上
• 金額は3桁カンマ区切り + ¥記号
• 入出金は色分け（緑/赤）

6.3 パフォーマンス
• すべての処理はクライアントサイドで即座に完了
• セッションタイマーは1秒ごとに更新

テストデータ
7.1 初期アカウント

| ユーザーID | パスワード | 役割 | 残高 | カード番号 |
|-----------|----------|------|------|-----------|
| customer01 | pass123 | customer | ¥1,500,000 | 4532-1234-5678-9012 |
| admin01 | admin123 | admin | ¥5,000,000 | 5412-7534-8642-9753 |
| auditor01 | audit123 | auditor | ¥2,000,000 | 3782-822463-10005 |

7.2 初期取引履歴（customer01）

| 日時 | 種別 | 説明 | 金額 |
|-----|------|------|------|
| 2024-01-15 14:30 | 入金 | 給与 | +¥350,000 |
| 2024-01-14 09:15 | 出金 | コンビニATM | -¥20,000 |
| 2024-01-12 18:45 | 振込 | 家賃支払い | -¥80,000 |

テストケース生成ガイドライン
8.1 カバレッジ目標
• 正常系: 各機能の基本フロー
• 異常系: バリデーション、エラーハンドリング
• 境界値: 金額上限/下限、文字数制限
• セキュリティ: 権限制御、監査ログ

8.2 優先度設定基準
• 高: ログイン、振込、セキュリティ関連
• 中: 表示機能、セッション管理
• 低: UI/UX、表示形式

Promptfoo用プロンプト設計
パターンA: 仕様書のみ

`yaml
prompts:
  - |
    あなたは金融システムのQAエンジニアです。
    以下の仕様書に基づき、E2Eテストケースを生成してください。
    
    【仕様書】
    {{specification}}
    
    【対象機能】
    {{feature}}
    
    【出力要件】
    - テストケースID: TC-XXX形式
    - カテゴリ: 正常系/異常系/境界値/セキュリティ
    - 優先度: 高/中/低
    - 前提条件、テスト手順、期待結果を明記
    - 最低10ケース生成

tests:
  - vars:
      specification: file://specs/securebank-spec.md
      feature: "ログイン機能（MFA含む）"
`

パターンB: HTML直接渡し

`yaml
prompts:
  - |
    以下のHTMLファイルで実装された金融システムのテストケースを生成してください。
    
    【ソースコード】
    {{sourcecode}}
    
    【対象機能】
    {{feature}}
    
    【分析指示】
    1. JavaScriptの関数から実際のバリデーションルールを抽出
    2. エラーメッセージから異常系を網羅
    3. 実装されているすべての分岐を特定
    
    【出力形式】
    (同上)

tests:
  - vars:
      sourcecode: file://financial-demo-app.html
      feature: "振込機能"
`

パターンC: ハイブリッド（推奨）

`yaml
prompts:
  - |
    金融システムのE2Eテストケースを生成してください。
    
    【業務仕様】
    {{specification}}
    
    【実装コード】
    {{sourcecode}}
    
    【対象機能】
    {{feature}}
    
    【指示】
    1. 仕様書からビジネス要件を理解
    2. 実装コードから実際のバリデーションルール・エラーメッセージを抽出
    3. 両者の整合性を確認
    4. 網羅的なテストケースを生成
    
    【出力形式】
    テストケースID: TC-XXX
    カテゴリ: [正常系/異常系/境界値/セキュリティ]
    優先度: [高/中/低]
    前提条件: 
    テスト手順:
    1. 
    2. 
    期待結果: 
    実装根拠: (コードの該当行を引用)

tests:
  - vars:
      specification: file://specs/securebank-spec.md
      sourcecode: file://financial-demo-app.html
      feature: "振込機能（バリデーション全パターン）"
    assert:
      - type: javascript
        value: output.match(/TC-\d+/g).length >= 15
      - type: contains-all
        value:
          - "残高不足"
          - "上限超過"
          - "自己振込"
          - "10桁"
      - type: llm-rubric
        value: "実装コードの具体的な行数を引用しているか"
`

実行例
promptfoo.yaml（完全版）

`yaml
prompts:
  - file://prompts/hybrid-test-generation.txt

providers:
  - id: openai:gpt-4o
    config:
      temperature: 0.2
      maxtokens: 4000
  
  - id: anthropic:claude-3-5-sonnet-20241022
    config:
      temperature: 0.2
      maxtokens: 4000
  
  - id: google:gemini-1.5-pro-latest
    config:
      temperature: 0.2
      maxtokens: 4000

tests:
  # テスト1: ログイン機能
  - description: "ログイン機能の網羅的テスト"
    vars:
      specification: file://specs/securebank-spec.md
      sourcecode: file://financial-demo-app.html
      feature: "ログイン機能（基本認証、MFA、ログイン試行制限）"
    assert:
      - type: javascript
        value: output.match(/TC-\d+/g).length >= 12
      - type: contains-all
        value:
          - "3回"
          - "30秒"
          - "MFA"
          - "123456"
      - type: llm-rubric
        value: "ログイン試行制限の仕様を正確に理解しているか（3回失敗→30秒ロック）"
      - type: cost
        threshold: 0.1  # $0.10以下

  # テスト2: 振込機能
  - description: "振込機能の境界値・異常系"
    vars:
      specification: file://specs/securebank-spec.md
      sourcecode: file://financial-demo-app.html
      feature: "振込機能（全バリデーション、承認フロー）"
    assert:
      - type: javascript
        value: output.match(/TC-\d+/g).length >= 15
      - type: contains-all
        value:
          - "¥999,999"
          - "¥1,000,000"
          - "¥1,000,001"
          - "¥100,000"
          - "承認"
      - type: llm-rubric
        value: "境界値テスト（¥1,000,000, ¥100,000）を含んでいるか"
      - type: llm-rubric
        value: "実装コードの具体的な関数名（transfer()等）を引用しているか"

  # テスト3: 権限制御
  - description: "役割ベースアクセス制御"
    vars:
      specification: file://specs/securebank-spec.md
      sourcecode: file://financial-demo-app.html
      feature: "監査ログ機能（アクセス権限制御）"
    assert:
      - type: contains-all
        value:
          - "customer"
          - "admin"
          - "auditor"
          - "非表示"
      - type: llm-rubric
        value: "一般顧客が監査ログにアクセスできないことをテストしているか"

defaultTest:
  options:
    provider:
      id: openai:gpt-4o

outputPath: ./results/evaluation-results.json
`

まとめ

| 質問 | 回答 |
|-----|------|
| HTMLを直接渡す？ | 可能。長文対応モデル（Claude 3.5 Sonnet等）なら推奨 |
| 仕様書のみ？ | 可能だが精度は下がる。実装と乖離するリスクあり |
| 仕様書を書き出せる？ | 可能。上記で完全な仕様書を提供済み |
| 推奨アプローチは？ | ハイブリッド（仕様書 + HTML）で最高精度 |

ファイル構成

`
project/
├── financial-demo-app.html         # デモアプリ
├── specs/
│   └── securebank-spec.md          # 仕様書（上記参照）
├── prompts/
│   └── hybrid-test-generation.txt  # プロンプトテンプレート
├── promptfoo.yaml                  # 評価設定
└── results/
    └── evaluation-results.json     # 評価結果
``

