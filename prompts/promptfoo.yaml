# プロンプト
prompts:
  - file://prompts/hybrid-test-generation.txt

# llm-rubric の採点モデル = OpenAI エンタープライズ API（OPENAI_API_KEY_ENTERPRISE）
defaultTest:
  options:
    provider:
      id: openai:gpt-4o
      config:
        apiKey: "{{env.OPENAI_API_KEY_ENTERPRISE}}"

providers:

  # OpenRouter 無料枠（OPENROUTER_API_KEY） ──────────────────────────────
  - id: openrouter:meta-llama/llama-4-scout:free
    config:
      temperature: 0.4
      max_tokens: 4000

  - id: openrouter:meta-llama/llama-4-maverick:free
    config:
      temperature: 0.4
      max_tokens: 4000

  - id: openrouter:google/gemini-2.0-flash-exp:free
    config:
      temperature: 0.4
      max_tokens: 4000

  - id: openrouter:deepseek/deepseek-v3-base:free
    config:
      temperature: 0.4
      max_tokens: 4000

  # OpenAI 個人 API（OPENAI_API_KEY） ──────────────────────────────────
  - id: openai:gpt-4o
    config:
      apiKey: "{{env.OPENAI_API_KEY}}"
      temperature: 0.4
      max_tokens: 4000

  - id: openai:gpt-4o-mini
    config:
      apiKey: "{{env.OPENAI_API_KEY}}"
      temperature: 0.4
      max_tokens: 4000

tests:

  # ------------------------------------------------------------
  # ログイン機能
  # ------------------------------------------------------------
  - description: "ログイン機能E2E（JUnit5 + Selenium）"
    vars:
      specification: file://specs/securebank-spec.md
      source_code: file://financial-demo-app.html
      feature: "ログイン機能（基本認証、MFA、ログイン試行制限）"

    assert:
      # 設計セクション
      - type: contains-all
        value:
          - "テスト設計（テストケース一覧）"
          - "テストケースID"
          - "期待結果"
          - "実装根拠"

      # JUnit5コードブロック
      - type: javascript
        value: /```java[\s\S]*org\.junit\.jupiter[\s\S]*```/m.test(output)

      # JUnit import存在
      - type: contains
        value: "org.junit.jupiter.api.Test"

      # Selenium利用
      - type: contains-all
        value:
          - "WebDriver"
          - "WebDriverWait"
          - "@Test"
          - "@BeforeEach"
          - "@AfterEach"

      # @Test数
      - type: javascript
        value: |
          const m = output.match(/@Test/g) || [];
          m.length >= 3

      # flakey対策
      - type: javascript
        value: "!output.includes('Thread.sleep')"

      # ダミーテスト検知
      - type: javascript
        value: "!output.includes('assertTrue(true)')"

      - type: llm-rubric
        value: "状態遷移・ロック・MFA・異常系・境界値・セキュリティがバランス良く含まれ実行可能"

  # ------------------------------------------------------------
  # 振込機能
  # ------------------------------------------------------------
  - description: "振込機能E2E（境界値・異常系・承認フロー）"
    vars:
      specification: file://specs/securebank-spec.md
      source_code: file://financial-demo-app.html
      feature: "振込機能（全バリデーション、承認フロー含む）"

    assert:
      - type: javascript
        value: /```java[\s\S]*WebDriver[\s\S]*```/m.test(output)

      - type: contains-all
        value:
          - "残高不足"
          - "上限"
          - "承認"

      - type: javascript
        value: |
          const m = output.match(/@Test/g) || [];
          m.length >= 3

      - type: javascript
        value: "!output.includes('Thread.sleep')"

      - type: javascript
        value: "!output.includes('assertTrue(true)')"

  # ------------------------------------------------------------
  # 権限制御
  # ------------------------------------------------------------
  - description: "RBAC（監査ログ）E2E"
    vars:
      specification: file://specs/securebank-spec.md
      source_code: file://financial-demo-app.html
      feature: "監査ログ機能（役割別アクセス制御）"

    assert:
      - type: contains-all
        value:
          - "admin"
          - "auditor"
          - "customer"

      - type: javascript
        value: /```java[\s\S]*@Test[\s\S]*```/m.test(output)

      - type: javascript
        value: "!output.includes('assertTrue(true)')"

  # ------------------------------------------------------------
  # 自己検証セクション
  # ------------------------------------------------------------
  - description: "自己検証セクション存在"
    vars:
      specification: file://specs/securebank-spec.md
      source_code: file://financial-demo-app.html
      feature: "共通"

    assert:
      - type: contains-all
        value:
          - "(D) 自己検証"
          - "total_cases:"
          - "category_counts:"
          - "duplicate_case_ids:"
          - "has_java_code_block:"

outputPath: ./results/evaluation-results.json